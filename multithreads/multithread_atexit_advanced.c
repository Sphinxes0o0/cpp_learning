#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <unistd.h>
#include <string.h>

// ç”¨äºæ ‡è¯†ä¸åŒatexitå‡½æ•°çš„ç»“æ„ä½“
typedef struct {
    int thread_id;
    char* thread_type;
} thread_info_t;

// å…¨å±€å˜é‡å­˜å‚¨çº¿ç¨‹ä¿¡æ¯
thread_info_t main_info = {0, "ä¸»çº¿ç¨‹"};
thread_info_t child_info1 = {1, "å­çº¿ç¨‹1"};
thread_info_t child_info2 = {2, "å­çº¿ç¨‹2"};

// ä¸»çº¿ç¨‹çš„atexitå›è°ƒå‡½æ•°
void main_thread_exit_handler() {
    printf("âœ“ ä¸»çº¿ç¨‹çš„atexitå‡½æ•°è¢«è°ƒç”¨ - ç¨‹åºå³å°†é€€å‡º\n");
    printf("  çº¿ç¨‹ä¿¡æ¯: %s (ID: %d)\n", main_info.thread_type, main_info.thread_id);
}

// ç¬¬ä¸€ä¸ªå­çº¿ç¨‹çš„atexitå›è°ƒå‡½æ•°
void child_thread1_exit_handler() {
    printf("âœ“ å­çº¿ç¨‹1çš„atexitå‡½æ•°è¢«è°ƒç”¨ - ç¨‹åºå³å°†é€€å‡º\n");
    printf("  çº¿ç¨‹ä¿¡æ¯: %s (ID: %d)\n", child_info1.thread_type, child_info1.thread_id);
}

// ç¬¬äºŒä¸ªå­çº¿ç¨‹çš„atexitå›è°ƒå‡½æ•°
void child_thread2_exit_handler() {
    printf("âœ“ å­çº¿ç¨‹2çš„atexitå‡½æ•°è¢«è°ƒç”¨ - ç¨‹åºå³å°†é€€å‡º\n");
    printf("  çº¿ç¨‹ä¿¡æ¯: %s (ID: %d)\n", child_info2.thread_type, child_info2.thread_id);
}

// ç¬¬äºŒä¸ªä¸»çº¿ç¨‹atexitå‡½æ•°ï¼Œæ¼”ç¤ºæ‰§è¡Œé¡ºåº
void main_thread_exit_handler2() {
    printf("âœ“ ä¸»çº¿ç¨‹çš„ç¬¬äºŒä¸ªatexitå‡½æ•°è¢«è°ƒç”¨ (LIFOé¡ºåº)\n");
}

// å­çº¿ç¨‹å‡½æ•°
void* child_thread_function(void* arg) {
    int thread_num = *(int*)arg;
    
    printf("ğŸš€ å­çº¿ç¨‹ %d å¼€å§‹æ‰§è¡Œ (pthread ID: %p)\n", thread_num, (void*)pthread_self());
    
    // æ ¹æ®çº¿ç¨‹ç¼–å·æ³¨å†Œä¸åŒçš„atexitå‡½æ•°
    if (thread_num == 1) {
        if (atexit(child_thread1_exit_handler) != 0) {
            fprintf(stderr, "âŒ å­çº¿ç¨‹1æ³¨å†Œatexitå‡½æ•°å¤±è´¥\n");
            return NULL;
        }
        printf("ğŸ“ å­çº¿ç¨‹1æ³¨å†Œäº†atexitå‡½æ•°\n");
    } else if (thread_num == 2) {
        if (atexit(child_thread2_exit_handler) != 0) {
            fprintf(stderr, "âŒ å­çº¿ç¨‹2æ³¨å†Œatexitå‡½æ•°å¤±è´¥\n");
            return NULL;
        }
        printf("ğŸ“ å­çº¿ç¨‹2æ³¨å†Œäº†atexitå‡½æ•°\n");
    }
    
    // å­çº¿ç¨‹åšä¸€äº›å·¥ä½œ
    printf("âš™ï¸  å­çº¿ç¨‹ %d æ­£åœ¨å·¥ä½œ...\n", thread_num);
    sleep(2);
    
    printf("âœ… å­çº¿ç¨‹ %d å³å°†ç»“æŸ\n", thread_num);
    return NULL;
}

int main() {
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("     å¤šçº¿ç¨‹atexitè¡Œä¸ºæ¼”ç¤ºç¨‹åº\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
    
    printf("ğŸ’¡ é‡è¦è¯´æ˜ï¼š\n");
    printf("   1. atexit()å‡½æ•°æ³¨å†Œçš„å›è°ƒå‡½æ•°åªåœ¨æ•´ä¸ªè¿›ç¨‹é€€å‡ºæ—¶è°ƒç”¨\n");
    printf("   2. æ— è®ºæ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯å­çº¿ç¨‹æ³¨å†Œçš„atexitå‡½æ•°ï¼Œéƒ½ä¼šåœ¨è¿›ç¨‹ç»“æŸæ—¶æ‰§è¡Œ\n");
    printf("   3. atexitå‡½æ•°æŒ‰ç…§LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰çš„é¡ºåºæ‰§è¡Œ\n");
    printf("   4. å­çº¿ç¨‹ç»“æŸä¸ä¼šè§¦å‘atexitå‡½æ•°ï¼Œåªæœ‰è¿›ç¨‹ç»“æŸæ‰ä¼šè§¦å‘\n\n");
    
    // ä¸»çº¿ç¨‹æ³¨å†Œatexitå‡½æ•°
    if (atexit(main_thread_exit_handler) != 0) {
        fprintf(stderr, "âŒ ä¸»çº¿ç¨‹æ³¨å†Œç¬¬ä¸€ä¸ªatexitå‡½æ•°å¤±è´¥\n");
        exit(1);
    }
    printf("ğŸ“ ä¸»çº¿ç¨‹æ³¨å†Œäº†ç¬¬ä¸€ä¸ªatexitå‡½æ•°\n");
    
    // ä¸»çº¿ç¨‹æ³¨å†Œç¬¬äºŒä¸ªatexitå‡½æ•°ï¼ˆæ¼”ç¤ºLIFOé¡ºåºï¼‰
    if (atexit(main_thread_exit_handler2) != 0) {
        fprintf(stderr, "âŒ ä¸»çº¿ç¨‹æ³¨å†Œç¬¬äºŒä¸ªatexitå‡½æ•°å¤±è´¥\n");
        exit(1);
    }
    printf("ğŸ“ ä¸»çº¿ç¨‹æ³¨å†Œäº†ç¬¬äºŒä¸ªatexitå‡½æ•°\n");
    
    // åˆ›å»ºå­çº¿ç¨‹
    pthread_t threads[2];
    int thread_nums[2] = {1, 2};
    
    printf("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸ”„ åˆ›å»ºå­çº¿ç¨‹\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    
    for (int i = 0; i < 2; i++) {
        if (pthread_create(&threads[i], NULL, child_thread_function, &thread_nums[i]) != 0) {
            fprintf(stderr, "âŒ åˆ›å»ºçº¿ç¨‹ %d å¤±è´¥\n", i + 1);
            exit(1);
        }
        printf("âœ… åˆ›å»ºäº†å­çº¿ç¨‹ %d\n", i + 1);
    }
    
    // ä¸»çº¿ç¨‹åšä¸€äº›å·¥ä½œ
    printf("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("âš™ï¸  ä¸»çº¿ç¨‹å·¥ä½œ\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸš€ ä¸»çº¿ç¨‹æ­£åœ¨å·¥ä½œ... (pthread ID: %p)\n", (void*)pthread_self());
    sleep(1);
    
    // ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆ
    printf("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("â³ ç­‰å¾…å­çº¿ç¨‹å®Œæˆ\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    
    for (int i = 0; i < 2; i++) {
        if (pthread_join(threads[i], NULL) != 0) {
            fprintf(stderr, "âŒ ç­‰å¾…çº¿ç¨‹ %d å¤±è´¥\n", i + 1);
            exit(1);
        }
        printf("âœ… å­çº¿ç¨‹ %d å·²å®Œæˆå¹¶å›æ”¶\n", i + 1);
    }
    
    printf("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸ ä¸»çº¿ç¨‹å³å°†é€€å‡º\n");
    printf("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n");
    printf("ğŸ“‹ æ³¨å†Œçš„atexitå‡½æ•°æ‰§è¡Œé¡ºåºï¼ˆLIFOï¼‰ï¼š\n");
    printf("   4. å­çº¿ç¨‹2çš„atexitå‡½æ•°\n");
    printf("   3. å­çº¿ç¨‹1çš„atexitå‡½æ•°\n");
    printf("   2. ä¸»çº¿ç¨‹çš„ç¬¬äºŒä¸ªatexitå‡½æ•°\n");
    printf("   1. ä¸»çº¿ç¨‹çš„ç¬¬ä¸€ä¸ªatexitå‡½æ•°\n\n");
    
    printf("ğŸ’¥ ç¨‹åºå³å°†é€€å‡ºï¼Œatexitå‡½æ•°å°†è¢«è°ƒç”¨...\n");
    printf("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    
    return 0; // ç¨‹åºæ­£å¸¸ç»“æŸï¼Œatexitå‡½æ•°å°†è¢«è°ƒç”¨
} 